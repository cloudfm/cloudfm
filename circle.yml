machine:
  pre:
    - curl -sSf https://static.rust-lang.org/rustup.sh | sudo sh -s -- --spec=nightly-2016-05-25
  environment:
    PATH: ~/.cargo/bin:$PATH
dependencies:
  override:
    - pip install ghp-import
    - npm install -g webpack typings
    - pushd app && npm install && typings install && popd
    - cargo install mdbook || true
  cache_directories:
    - "~/.cargo"
test:
  override:
    - case $CIRCLE_NODE_INDEX in \
        0) pushd lib && cargo build && cargo test && popd ;; \
        1) pushd app && webpack && popd ;; \
        2) pushd doc && mdbook build && popd ;; \
      esac:
        parallel: true
general:
  branches:
    ignore:
      - gh-pages
      - staging
deployment:
  staging:
    branch: master
    commands:
      - git push origin master:staging
      # would prefer to have this under "docs", but only one deployment is executed per build
      # https://discuss.circleci.com/t/deploy-same-branch-to-multiple-apps/1886
      - ghp-import -n doc/book -m "[ci skip] build docs"
      - git push -fq origin gh-pages
